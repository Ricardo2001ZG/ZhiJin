# AutoBuild ğŸ› ï¸

AutoBuild æ˜¯ä¸€ä¸ª Python é¡¹ç›®ï¼Œæ—¨åœ¨ä¸ºå¼€å‘è€…æä¾›è‡ªåŠ¨æ„å»ºã€éƒ¨ç½²å’Œæµ‹è¯•ç­‰åŠŸèƒ½ã€‚å®ƒå¯ä»¥ä¸å¸¸è§çš„ç‰ˆæœ¬æ§åˆ¶å·¥å…·ï¼ˆå¦‚ Git å’Œ SVNï¼‰ç»“åˆä½¿ç”¨ï¼Œå¹¶æ”¯æŒä½¿ç”¨ Fastbuild ç­‰å·¥å…·è¿›è¡Œè½¯ä»¶æ„å»ºã€‚

**è¯¥é¡¹ç›®è¿˜åœ¨å¼€å‘ä¸­ï¼åŠŸèƒ½å±•ç¤ºå¹¶ä¸ä»£è¡¨å®é™…å¯ç”¨** ğŸ‘·â€â™‚ï¸

## âš™ï¸ åŠŸèƒ½ä»‹ç»
---

### å®ä¾‹æ§åˆ¶ ğŸ’»

æœ¬åŠŸèƒ½æ˜¯åŸºäº WebSocket çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å®¢æˆ·ç«¯ç¨‹åºï¼Œå¯ä»¥é€šè¿‡ä¸æœåŠ¡ç«¯å»ºç«‹ WebSocket è¿æ¥ï¼Œå¹¶ä¿æŒå¿ƒè·³è¿æ¥ä»¥åŠæ¥æ”¶æŒ‡ä»¤æ¥å®ç°ã€‚ç¨‹åºä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š

1. è·å–æœ¬åœ°æœºå™¨çš„å®ä¾‹ä¿¡æ¯ï¼Œå¹¶å‘é€ç»™æœåŠ¡ç«¯ã€‚
2. æ¥æ”¶æœåŠ¡ç«¯ä¸‹å‘çš„æŒ‡ä»¤ï¼Œå¹¶æ ¹æ®ä¸åŒçš„æŒ‡ä»¤ç±»å‹æ‰§è¡Œç›¸åº”çš„æ“ä½œï¼Œæœ€åå°†æ‰§è¡Œç»“æœåé¦ˆç»™æœåŠ¡ç«¯ã€‚
3. æ”¯æŒåœ¨ç»ˆç«¯æŒ‰ä¸‹ Ctrl-C å–æ¶ˆæŒ‰é’®æ—¶ï¼Œè‡ªåŠ¨åˆ¤æ–­å®¢æˆ·ç«¯æ˜¯å¦å·²ç»è¿æ¥ä¸ŠæœåŠ¡ç«¯ï¼Œå¦‚æœæ²¡æœ‰è¿æ¥åˆ™ç›´æ¥é€€å‡ºï¼Œå¦‚æœè¿ä¸ŠæœåŠ¡ç«¯åˆ™å°è¯•å®‰å…¨æ–­å¼€è¿æ¥ã€‚

æ­¤å¤–ï¼Œè¿˜æä¾›å…¶ä»–è¾…åŠ©å‡½æ•°ï¼Œå¦‚è·å–æœåŠ¡å™¨åœ°å€åŠç«¯å£å·ã€è·å–å·¥ä½œè·¯å¾„ã€è·å–ç¡¬ç›˜ä¿¡æ¯ç­‰ã€‚

### éƒ¨ç½²é¡¹ç›® ğŸš€

æœ¬åŠŸèƒ½å®ƒå¯ä»¥é€šè¿‡æ£€æŸ¥ç›®æ ‡é¡¹ç›®æ˜¯å¦å­˜åœ¨å’Œå¯è¯»æ€§æ¥ç¡®ä¿é¡¹ç›®çš„æœ‰æ•ˆæ€§ï¼Œå¹¶ä¸‹è½½å’Œè§£å‹ç¼©å®‰è£…è½¯ä»¶åŒ…ã€‚æ­¤å¤–ï¼Œè¿˜æä¾›äº†æ‹‰å–é¡¹ç›®ä»£ç çš„åŠŸèƒ½ï¼Œå¹¶æ”¯æŒåœ¨Gitå’ŒSVNä¹‹é—´è¿›è¡Œé€‰æ‹©ã€‚

1. æ£€æŸ¥æŒ‡å®šè·¯å¾„æ˜¯å¦å­˜åœ¨ä»¥åŠæ˜¯å¦å¯è¯»
2. æ”¯æŒä¸‹è½½å®‰è£…åŒ…ï¼Œå¹¶ä¸”è‡ªè¡Œè§£å‹
3. è‡ªåŠ¨å®‰è£… Git å’Œ SVNç¯å¢ƒ
4. æ”¯æŒ git æˆ–è€… svn æ‹‰å–é¡¹ç›®ä»£ç 

- å®ä¾‹æ§åˆ¶ï¼šå°†æœºå™¨ç¡¬ä»¶ç­‰ä¿¡æ¯ä¸Šä¼ è‡³ä¸­å¿ƒæ§åˆ¶æœåŠ¡å™¨ï¼Œå¹¶æ¥æ”¶æ§åˆ¶æœåŠ¡å™¨ä¸‹å‘çš„æŒ‡ä»¤ã€‚
- éƒ¨ç½²é¡¹ç›®ï¼šé€šè¿‡ git æˆ– svn éƒ¨ç½²é¡¹ç›®åˆ°æŒ‡å®šçš„å·¥ä½œæ–‡ä»¶å¤¹ä¸­ï¼Œå¹¶è‡ªè¡Œç»´æŠ¤æ›´æ–°ã€‚
- æ‰§è¡Œå‘½ä»¤/ç¼–è¯‘ï¼šä½¿ç”¨ Fastbuild ç­‰å·¥å…·æ¥æ„å»ºé¡¹ç›®çš„äº§ç‰©ã€‚
- ä¸Šä¼ äº§ç‰©ï¼šç¼–è¯‘ç»“æŸåçš„äº§ç‰©èƒ½å¤Ÿè¢«ä¸Šä¼ åˆ°æŒ‡å®šä½ç½®ï¼Œæ”¯æŒå…¶ä»–ç¬¬ä¸‰æ–¹ SDK ä¸Šä¼ è®¾ç½®ã€‚
- æ¸…ç†å·¥ä½œï¼šå°†ç¼–è¯‘ç»“æŸåçš„ä¸´æ—¶åƒåœ¾è¿›è¡Œæ¸…ç†ã€‚

### æ‰§è¡Œç¼–è¯‘ ğŸ“¦

æœ¬åŠŸèƒ½ä¸»è¦ç”¨äºè‡ªåŠ¨åŒ–åœ°ç¼–è¯‘å’Œæ„å»ºä»£ç ã€‚å¯ä»¥æ ¹æ®ä¼ å…¥çš„å‚æ•°ï¼Œè‡ªåŠ¨æ‰§è¡Œç¼–è¯‘å‘½ä»¤å’Œæ„å»ºå‘½ä»¤ï¼Œå¹¶å®æ—¶æ‰“å°æ„å»ºè¿›åº¦ã€‚

ä¸»è¦åŒ…å«ä»¥ä¸‹åŠŸèƒ½ï¼š

1. æ£€æŸ¥ç¼–è¯‘ç¯å¢ƒæ˜¯å¦ç¬¦åˆè¦æ±‚
2. æ›´æ”¹å½“å‰å·¥ä½œç›®å½•ä¸ºé¡¹ç›®æ ¹ç›®å½•
3. æ‰§è¡Œç¼–è¯‘å‘½ä»¤
4. è®¡ç®—æ„å»ºè¿›åº¦ç™¾åˆ†æ¯”ï¼Œå¹¶å®æ—¶æ‰“å°æ„å»ºè¿›åº¦
5. æ£€æŸ¥æ„å»ºç»“æœï¼Œè¿”å›æ„å»ºçŠ¶æ€ä¿¡æ¯

### ä¸Šä¼ äº§ç‰© â¬†ï¸

æœ¬åŠŸèƒ½å®ç°äº†ä¸Šä¼ äº§ç‰©çš„åŠŸèƒ½ï¼Œå¯ä»¥å°†æŒ‡å®šç›®å½•ä¸‹çš„æ–‡ä»¶ä¸Šä¼ åˆ°æŒ‡å®šçš„æœåŠ¡å™¨ä¸Šã€‚
**TODO**


## ğŸš€ å¿«é€Ÿä¸Šæ‰‹

### å¯åŠ¨æœåŠ¡ç«¯å’Œè¢«æ§ç«¯
1. è¯·ç¡®ä¿**æœåŠ¡ç«¯,å®¢æˆ·ç«¯,è¢«æ§ç«¯**ç”µè„‘å·²ç»æœ‰å®‰è£…å¥½[Python 3.10](https://www.python.org/downloads/release/python-3100/)æˆ–è€…æ›´é«˜ç‰ˆæœ¬çš„Python

2. ç„¶åè¿›è¡Œä¾èµ–åº“çš„å®‰è£…
```bash
pip install -r requirements.txt
```

3. å¯åŠ¨æœåŠ¡ç«¯
> è¿™é‡Œä¸ºäº†è·Ÿç°æœ‰çš„Flask åº”ç”¨é›†æˆ,ç»™å‡ºçš„æ˜¯ä»¥APIå½¢å¼,å…·ä½“æ–‡ä»¶åœ¨ `websocket_server_api.py`
> ä½ éœ€è¦åœ¨ä½ è‡ªå·±çš„Flaskåº”ç”¨å†…é›†æˆä»–,æˆ–è€…å‚è€ƒ`demo_server.py`ä»£ç 
```bash
python demo_server.py
```

4. å¯åŠ¨è¢«æ§ç«¯
> æ³¨æ„:ä¸èƒ½æœ‰ä¸­æ–‡è·¯å¾„!
åˆ›å»ºä¸€ä¸ª config æ–‡ä»¶å†™å…¥æœåŠ¡ç«¯çš„IPå’ŒPort

```
host=localhost
port=5000
```
å¯åŠ¨è¢«æ§ç«¯
```bash
python agent.py
```

5. æŸ¥çœ‹è¾“å‡º
æ­¤æ—¶æœåŠ¡ç«¯çš„è¾“å‡ºåº”è¯¥å¦‚ä¸‹
```
ä¾‹ 09e7737c-f718-11ed-ad1a-9e565be2af5a å·²è¿æ¥åˆ°æ§åˆ¶ä¸­å¿ƒï¼
å®ä¾‹ä¿¡æ¯ï¼š {'cpu': 'Intel64 Family 6 Model 85 Stepping 4, GenuineIntel 2', 'memory': '16.0 GB', 'disk': '52.32 GB / 60.0 GB', 'ip_address': '172.30.113.141', 'name': 'WINDOWS', 'uuid': '09e7737c-f718-11ed-ad1a-9e565be2af5a', 'last_heartbeat': 1684591813, 'connected_at': '2023-05-20 22:10:13', 'sid': 'x9PgkStgCyL_aXV9AAAB', 'state': 'connected'}
å½“å‰ç»ˆç«¯å®ä¾‹åˆ—è¡¨ï¼š {'09e7737c-f718-11ed-ad1a-9e565be2af5a': {'cpu': 'Intel64 Family 6 Model 85 Stepping 4, GenuineIntel 2', 'memory': '16.0 GB', 'disk': '52.32 GB / 60.0 GB', 'ip_address': '172.30.113.141', 'name': 'WINDOWS', 'uuid': '09e7737c-f718-11ed-ad1a-9e565be2af5a', 'last_heartbeat': 1684591813, 'connected_at': '2023-05-20 22:10:13', 'sid': 'x9PgkStgCyL_aXV9AAAB', 'state': 'connected'}}
09e7737c-f718-11ed-ad1a-9e565be2af5a ç»‘å®š x9PgkStgCyL_aXV9AAAB å®¢æˆ·ç«¯
```

è¢«æ§ç«¯è¾“å‡ºå¦‚ä¸‹
```
Work directory: C:\Users\ADMINI~1\AppData\Local\Temp
UUIDï¼š09e7737c-f718-11ed-ad1a-9e565be2af5a
```

åœ¨æœåŠ¡ç«¯ä¸Šæ‰“å¼€[http://127.0.0.1:5000](http://127.0.0.1)å¯ä»¥çœ‹åˆ°å®ä¾‹åˆ—è¡¨å¦‚ä¸‹

![instances](./assests/instances.png)


### æ‰§è¡Œä»»åŠ¡
é¦–å…ˆå…ˆè·ŸæœåŠ¡ç«¯è¿æ¥ä¸Š

```python
# åˆ›å»º SocketIO å®¢æˆ·ç«¯å®ä¾‹
sio = socketio.Client()

# è¿æ¥æœåŠ¡å™¨
sio.connect("http://localhost:5000")
```

ç›®å‰åªæœ‰å¤„ç†æœ‰é™æŒ‡ä»¤,æ¯”å¦‚ 
* `get_instances`: è·å–å®ä¾‹ä¿¡æ¯
* `pull`: éƒ¨ç½²æˆ–è€…æ›´æ–°é¡¹ç›®
* `build`: æ„å»ºé¡¹ç›®

æ‰§è¡ŒæŒ‡ä»¤éœ€è¦ä¸¤ä¸ªéƒ¨åˆ†
ä¸‹é¢ä»¥éƒ¨ç½²é¡¹ç›®ä¸ºä¾‹å­

1. æ„å»ºæŒ‡ä»¤
æ„å»ºæŒ‡ä»¤éœ€è¦å…ƒç´ å¦‚ä¸‹
* `command`: è¿™ä¸ªæ˜¯ç»™å…·ä½“æ‰§è¡ŒæŒ‡ä»¤çš„è¢«æ§ç«¯ä½¿ç”¨,é‡Œé¢åŒ…å«éœ€è¦æ‰§è¡ŒæŒ‡ä»¤çš„æ•°æ®
* `type`: æŒ‡ä»¤çš„ç±»å‹
* `uuid`: æ‰§è¡Œè¯¥æŒ‡ä»¤æœºå™¨çš„UUID
* `callback`: å›è°ƒäº‹ä»¶åç§°,å¦‚æœæŒ‡ä»¤æ‰§è¡Œå®Œæ¯•ä¹‹åéœ€è¦å‘é€æ•°æ®å›æ¥,åˆ™ä¼šå‘é€ç»“æœåˆ°`callback`å¤„

é‚£ä¹ˆæ•´ä¸ªçš„æŒ‡ä»¤åº”è¯¥æ˜¯è¿™æ ·å­
```python
# command æ˜¯è¢«å®ä¾‹æ‰§è¡Œéœ€è¦çš„æ•°æ®
command = {
    "type": "pull",
    "project_name": "ZhiJin",
    "url": "https://github.com/Ricardo2001ZG/ZhiJin.git",
    "branch": "main"
}

# å°†æŒ‡ä»¤å°è£…å¥½å‘ç»™æœåŠ¡ç«¯
data = {
    "command": command,
    "uuid": "UUID of machine",
    "callback": "pull_result" # å›è°ƒå‡½æ•°
}

sio.emit("command", json.dumps(data),callback=callback_command)
```


2. å®šä¹‰å›è°ƒäº‹ä»¶
åœ¨æˆ‘ä»¬å‘é€æŒ‡ä»¤ä¹‹å,å¦‚æœéœ€è¦è·å–æŒ‡ä»¤å®Œæˆä¹‹åçš„æ•°æ®
åˆ™éœ€è¦è®¾ç½®ä¸€ä¸ªå›è°ƒå‡½æ•°,å‘ŠçŸ¥æœåŠ¡ç«¯åœ¨æŒ‡ä»¤å®Œæˆä¹‹åå°†æ•°æ®å‘åˆ°æŒ‡å®šçš„å›è°ƒäº‹ä»¶

**æ³¨æ„**:ä¸åŒçš„æŒ‡ä»¤è¿”å›çš„æ ¼å¼å¹¶ä¸é€šç”¨,å…·ä½“å¯ä»¥çœ‹ `websocket_server_api.py`ä¸­çš„ä»£ç 
```python
# å¤„ç† pull_result äº‹ä»¶ï¼Œå¹¶è¾“å‡ºæœåŠ¡å™¨è¿”å›çš„ pull ç»“æœ
@sio.on("pull_result")
def handle_pull_result(data):
    global FINSH,PROJECT_PATH

    # å°† JSON æ ¼å¼çš„å­—ç¬¦ä¸²è½¬æ¢ä¸º Python å¯¹è±¡
    result = json.loads(data)

    # è¾“å‡º pull ç»“æœä¿¡æ¯
    print("Pull ç»“æœï¼š")
    print("è¿”å›ä»£ç ï¼š", result["code"])
    print("è¿”å›ä¿¡æ¯ï¼š", result["message"])
    
    # æ›´æ–°é¡¹ç›®çš„è·¯å¾„
    PROJECT_PATH = result['project_path']
    FINSH = True
```

è‡³æ­¤,æ•´ä¸ªå¿«é€Ÿä¸Šæ‰‹å†…å®¹å·²ç»è®²å®Œ,æ›´å¤šä½¿ç”¨çš„ç»†èŠ‚å¯ä»¥å‚è€ƒ `demo.py` (æˆ–è€…å°†`demo.py`å–‚ç»™new bingä¹Ÿè¡Œ)